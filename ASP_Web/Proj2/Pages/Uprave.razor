@page "/uprave"
@using Microsoft.AspNetCore.SignalR.Client
@using Proj2.Database
@using Proj2.Code

@inject AuthStateProvider AuthStateProvider
@inject NavigationManager Navigation

<PageTitle>Uprave</PageTitle>

<AuthorizeView>
	<Authorized>
		<div class="accordion mx-2 my-2">
			@{
				int Counter = 0;

				string GetCounter() {
					return "item_" + Counter;
				}
			}

			@foreach (Uprava Up in ListUprave) {
				Counter++;
				GetUpravaStyle(Up, out string UpravaButtonStyle, out bool UpravaHasError, out bool UpravaHasWarning);

				<div class="accordion-item">
					<h2 class="accordion-header">
						<button class="accordion-button @UpravaButtonStyle collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#@GetCounter()" aria-expanded="true" aria-controls="@GetCounter()">
							<p class="mx-0 my-0">
								@Up.Name

								@if (UpravaHasError) { // TODO: ALERT/WARNING badges
									<span class="badge bg-danger ms-2">ERROR</span>
								}

								@if (UpravaHasWarning) { // TODO: ALERT/WARNING badges
									<span class="badge bg-warning ms-2">WARNING</span>
								}
							</p>
						</button>
					</h2>
					<div id="@GetCounter()" class="accordion-collapse collapse" data-bs-parent="#accordionExample">
						<div class="accordion-body">

							<div class="container">
								<div class="row mb-2">
									<div class="col">
										<button class="btn btn-outline-primary" @onclick="@(e=> OnPregledUprave(Up))">Pregled Uprave</button>
									</div>
								</div>

								<div class="row">
									<div class="col">
										<AddressView CurrentAddress="Up.Address" />
										<strong>Broj Vozila: </strong>@Up.Vozila.Count<br />
									</div>
								</div>

								@if ((Up.Vozila?.Count ?? 0) > 0) {

									<div class="row">
										<div class="col">
											@*<hr class="my-2">*@
											<ul class="list-group mt-3">
												@foreach (Vozilo V in Up.Vozila) {
													GetVoziloStyle(V, out string ListGroupItemStyle, out string ButtonStyle, out bool HasError, out bool HasWarning);

													<li class="list-group-item p-1 @ListGroupItemStyle">
														@*<div class="d-flex bd-highlight justify-content-between align-items-center">
											<p class="m-0">@V.Name</p>
											<p class="m-0">@V.Tablica</p>


											@if (HasError) {
											<span class="badge bg-danger m-0">ERROR</span>
											} else {
											<span></span>
											}

											@if (HasWarning) {
											<span class="badge bg-warning m-0">WARNING</span>
											} else {
											<span></span>
											}

											<button class="btn btn-sm @ButtonStyle">Pregled Vozila</button>
											</div>*@

														<div class="container">
															<div class="row">
																<div class="col p-0">
																	<p class="m-0">@V.Name</p>
																</div>

																<div class="col p-0">
																	<p class="m-0">@V.Tablica</p>
																</div>

																<div class="col p-0">
																	@if (HasError) {
																		<span class="badge bg-danger mx-1">ERROR</span>
																	}

																	@if (HasWarning) {
																		<span class="badge bg-warning mx-1">WARNING</span>
																	}
																</div>

																<div class="col p-0">
																	<button class="btn btn-sm float-end @ButtonStyle" @onclick="@(e=> OnPregledVozila(V))">Pregled Vozila</button>
																</div>
															</div>
														</div>
													</li>
												}
											</ul>
										</div>
									</div>

								}
							</div>
						</div>
					</div>
				</div>
			}

			<div class="accordion-item">
				<h2 class="accordion-header">
					<button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#item_addnew" aria-expanded="true" aria-controls="item_addnew">
						<p class="mx-0 my-0">
							<span class="oi oi-wrench"></span>
							<span> Edit</span>
						</p>
					</button>
				</h2>
				<div id="item_addnew" class="accordion-collapse collapse" data-bs-parent="#accordionExample">
					<div class="accordion-body">
						<button class="btn btn-outline-success">Create New</button>
					</div>
				</div>
			</div>
		</div>
	</Authorized>

</AuthorizeView>

@code {
	public List<Uprava> ListUprave = new(Structures.Uprave);

	void GetUpravaStyle(Uprava U, out string UpravaButtonStyle, out bool HasError, out bool HasWarning) {
		UpravaButtonStyle = "";

		HasWarning = U.HasWarnings();
		HasError = U.HasErrors();

		if (HasError) {
			UpravaButtonStyle = "list-group-item-danger";
		} else if (HasWarning) {
			UpravaButtonStyle = "list-group-item-warning";
		}
	}

	void GetVoziloStyle(Vozilo V, out string ListGroupItemStyle, out string ButtonStyle, out bool HasError, out bool HasWarning) {
		ListGroupItemStyle = "";
		ButtonStyle = "btn-outline-secondary";

		HasWarning = V.HasWarnings();
		HasError = V.HasErrors();


		if (HasError) {
			ListGroupItemStyle = "list-group-item-danger";
			ButtonStyle = "btn-danger";
		} else if (HasWarning) {
			ListGroupItemStyle = "list-group-item-warning";
			ButtonStyle = "btn-warning";
		}
	}

	protected override void OnAfterRender(bool firstRender) {
		if (!AuthStateProvider.IsAuthenticated())
			Navigation.NavigateTo("/login");
	}

	void OnPregledUprave(Uprava Up) {
		Navigation.NavigateTo("/pregled_uprave?i=" + Up.ID);
	}

	void OnPregledVozila(Vozilo V) {
		Navigation.NavigateTo("/pregled_vozila?i=" + V.ID);
	}
}